# name: test/sql/concurrency.test
# description: Test concurrent access patterns for OTLP storage extension
# group: [sql]

require duckspan

# Test concurrent reads from ring buffer-backed tables
# The gRPC receiver runs on a background thread, so querying while attached
# exercises the thread-safe ring buffer implementation

statement ok
ATTACH 'otlp:localhost:4320' AS concurrent_test (TYPE otlp);

# Query all three tables to ensure ring buffers are accessible
query I
SELECT COUNT(*) FROM concurrent_test.otel_traces;
----
0

query I
SELECT COUNT(*) FROM concurrent_test.otel_logs;
----
0

query I
SELECT COUNT(*) FROM concurrent_test.otel_metrics_gauge;
----
0

# Test multiple queries in sequence (simulates concurrent access pattern)
query I
SELECT COUNT(*) FROM concurrent_test.otel_traces;
----
0

query I
SELECT COUNT(*) FROM concurrent_test.otel_logs;
----
0

query I
SELECT COUNT(*) FROM concurrent_test.otel_metrics_gauge;
----
0

# Test querying while another attachment exists (multiple ring buffers active)
statement ok
ATTACH 'otlp:localhost:4321' AS concurrent_test2 (TYPE otlp);

query I
SELECT COUNT(*) FROM concurrent_test.otel_traces;
----
0

query I
SELECT COUNT(*) FROM concurrent_test2.otel_traces;
----
0

# Detach in different order than attach
statement ok
DETACH concurrent_test;

query I
SELECT COUNT(*) FROM concurrent_test2.otel_traces;
----
0

statement ok
DETACH concurrent_test2;
