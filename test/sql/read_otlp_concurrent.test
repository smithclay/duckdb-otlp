# name: test/sql/read_otlp_concurrent.test
# description: test concurrent access and parallel scanning
# group: [sql]

require otlp

### Basic Parallel Scan Tests ###

# Test parallel read of same file in multiple subqueries
query I
SELECT
    (SELECT COUNT(*) FROM read_otlp_traces('test/data/traces_simple.jsonl')) +
    (SELECT COUNT(*) FROM read_otlp_traces('test/data/traces_simple.jsonl')) +
    (SELECT COUNT(*) FROM read_otlp_traces('test/data/traces_simple.jsonl'))
AS total_count;
----
9

# Test parallel read of different files
query I
SELECT
    (SELECT COUNT(*) FROM read_otlp_traces('test/data/traces_simple.jsonl')) +
    (SELECT COUNT(*) FROM read_otlp_traces('test/data/traces_nulls.jsonl')) +
    (SELECT COUNT(*) FROM read_otlp_traces('test/data/single_trace.jsonl'))
AS total_count;
----
7

# Test parallel metrics reads
query I
SELECT
    (SELECT COUNT(*) FROM read_otlp_metrics_gauge('test/data/metrics_simple.jsonl')) +
    (SELECT COUNT(*) FROM read_otlp_metrics_sum('test/data/metrics_simple.jsonl'))
AS total_count;
----
2

### Union Operations ###

# Test UNION of multiple file reads
query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_otlp_traces('test/data/traces_simple.jsonl')
    UNION ALL
    SELECT * FROM read_otlp_traces('test/data/traces_nulls.jsonl')
);
----
6

# Test JOIN across different OTLP data types
query I
SELECT COUNT(*)
FROM read_otlp_traces('test/data/traces_simple.jsonl') t
JOIN read_otlp_logs('test/data/logs_simple.jsonl') l
ON t.trace_id = l.trace_id;
----
6

### Glob Pattern Parallel Scanning ###

# Test glob pattern (DuckDB parallelizes file-level)
query I
SELECT COUNT(*) FROM read_otlp_traces('test/data/traces_*.jsonl');
----
8

# Test glob with logs
query I
SELECT COUNT(*) FROM read_otlp_logs('test/data/logs_*.jsonl');
----
6

### CTEs with Multiple Scans ###

# Test Common Table Expressions with parallel scans
query I
WITH
    traces AS (SELECT COUNT(*) as cnt FROM read_otlp_traces('test/data/traces_simple.jsonl')),
    logs AS (SELECT COUNT(*) as cnt FROM read_otlp_logs('test/data/logs_simple.jsonl'))
SELECT traces.cnt + logs.cnt
FROM traces, logs;
----
6

### Window Functions Over Parallel Scans ###

# Test window functions (DuckDB may parallelize)
query I
SELECT COUNT(DISTINCT span_name)
FROM read_otlp_traces('test/data/traces_*.jsonl');
----
8

### Subquery Correlation ###

# Test correlated subquery with OTLP reads
query I
SELECT COUNT(*) FROM (
    SELECT
        span_name,
        (SELECT COUNT(*) FROM read_otlp_traces('test/data/traces_simple.jsonl') WHERE span_name = t.span_name) as same_name_count
    FROM read_otlp_traces('test/data/traces_simple.jsonl') t
);
----
3
