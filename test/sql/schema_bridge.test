# name: test/sql/schema_bridge.test
# description: Test materializing OTLP file readers into permanent tables
# group: [sql]

require otlp

#
# Test 1: Copy gauge metrics from read_otlp_metrics_gauge()
#

statement ok
CREATE TABLE archive_gauge_from_file AS
SELECT timestamp, service_name, metric_name, metric_description, metric_unit,
       resource_attributes, scope_name, scope_version, metric_attributes, value
FROM read_otlp_metrics_gauge('test/data/metrics_simple.jsonl');

query I
SELECT COUNT(*) FROM archive_gauge_from_file;
----
1

query I
SELECT CAST(value AS BIGINT) FROM archive_gauge_from_file;
----
524288000

#
# Test 2: Copy sum metrics from read_otlp_metrics_sum()
#

statement ok
CREATE TABLE archive_sum_from_file AS
SELECT timestamp, service_name, metric_name, metric_description, metric_unit,
       resource_attributes, scope_name, scope_version, metric_attributes,
       value, aggregation_temporality, is_monotonic
FROM read_otlp_metrics_sum('test/data/metrics_simple.jsonl');

query I
SELECT COUNT(*) FROM archive_sum_from_file;
----
1

query I
SELECT is_monotonic FROM archive_sum_from_file;
----
true

#
# Test 3: Logs table materialization
#

statement ok
CREATE TABLE logs_table AS
SELECT timestamp, severity_text, body
FROM read_otlp_logs('test/data/logs_simple.jsonl');

query I
SELECT COUNT(*) FROM logs_table;
----
3

#
# Test 4: Traces table materialization
#

statement ok
CREATE TABLE traces_table AS
SELECT timestamp, span_name, service_name, duration
FROM read_otlp_traces('test/data/traces_simple.jsonl');

query I
SELECT COUNT(*) FROM traces_table;
----
3

#
# Cleanup
#

statement ok
DROP TABLE archive_gauge_from_file;

statement ok
DROP TABLE archive_sum_from_file;

statement ok
DROP TABLE logs_table;

statement ok
DROP TABLE traces_table;
