# name: test/sql/read_otlp_json.test
# description: Test read_otlp_*() table functions with JSON files
# group: [sql]

require otlp

# Test that table functions exist
query I
SELECT COUNT(*) FROM duckdb_functions() WHERE function_name IN ('read_otlp_traces', 'read_otlp_logs', 'read_otlp_metrics');
----
3

#
# Traces Tests
#

# Test reading traces - verify row count
query I
SELECT COUNT(*) FROM read_otlp_traces('test/data/traces_simple.jsonl');
----
3

# Test traces schema - verify key column types
query IIIII
SELECT
    typeof(timestamp) as ts_type,
    typeof(trace_id) as trace_id_type,
    typeof(span_id) as span_id_type,
    typeof(service_name) as service_type,
    typeof(duration) as duration_type
FROM read_otlp_traces('test/data/traces_simple.jsonl')
LIMIT 1;
----
TIMESTAMP_MS	VARCHAR	VARCHAR	VARCHAR	BIGINT

# Test traces content - verify specific values
query III
SELECT
    LENGTH(trace_id) > 0 as has_trace_id,
    LENGTH(span_id) > 0 as has_span_id,
    service_name = 'test-service' as correct_service
FROM read_otlp_traces('test/data/traces_simple.jsonl')
LIMIT 1;
----
true	true	true

# Test traces - verify span name extraction
query I
SELECT COUNT(*)
FROM read_otlp_traces('test/data/traces_simple.jsonl')
WHERE span_name LIKE '%users%';
----
2

# Test traces - verify duration is calculated
query I
SELECT COUNT(*)
FROM read_otlp_traces('test/data/traces_simple.jsonl')
WHERE duration > 0;
----
3

#
# Logs Tests
#

# Test reading logs - verify row count
query I
SELECT COUNT(*) FROM read_otlp_logs('test/data/logs_simple.jsonl');
----
3

# Test logs schema - verify key column types
query IIII
SELECT
    typeof(timestamp) as ts_type,
    typeof(service_name) as service_type,
    typeof(severity_text) as severity_type,
    typeof(body) as body_type
FROM read_otlp_logs('test/data/logs_simple.jsonl')
LIMIT 1;
----
TIMESTAMP_MS	VARCHAR	VARCHAR	VARCHAR

# Test logs content - verify specific values
query II
SELECT
    service_name = 'test-service' as correct_service,
    LENGTH(body) > 0 as has_body
FROM read_otlp_logs('test/data/logs_simple.jsonl')
LIMIT 1;
----
true	true

# Test logs - verify severity levels
query I
SELECT COUNT(*)
FROM read_otlp_logs('test/data/logs_simple.jsonl')
WHERE severity_text IN ('INFO', 'WARN', 'ERROR');
----
3

# Test logs - JSON document files (multi-line)
query I
SELECT COUNT(*) FROM read_otlp_logs('test/data/logs_document.json');
----
1

query TT
SELECT service_name, body FROM read_otlp_logs('test/data/logs_document.json');
----
my.service	Example log record

#
# Gauge Metrics Tests
#

# Test reading gauge metrics
query I
SELECT COUNT(*) FROM read_otlp_metrics_gauge('test/data/metrics_simple.jsonl');
----
1

# Test gauge metric value
query I
SELECT CAST(value AS BIGINT)
FROM read_otlp_metrics_gauge('test/data/metrics_simple.jsonl');
----
524288000

#
# Sum Metrics Tests
#

# Test reading sum metrics
query I
SELECT COUNT(*) FROM read_otlp_metrics_sum('test/data/metrics_simple.jsonl');
----
1

# Test sum metric value
query I
SELECT CAST(value AS BIGINT)
FROM read_otlp_metrics_sum('test/data/metrics_simple.jsonl');
----
42

# Test aggregation temporality is INTEGER typed
query I
SELECT typeof(aggregation_temporality)
FROM read_otlp_metrics_sum('test/data/metrics_simple.jsonl');
----
INTEGER

# Test is_monotonic is BOOLEAN typed
query I
SELECT typeof(is_monotonic)
FROM read_otlp_metrics_sum('test/data/metrics_simple.jsonl');
----
BOOLEAN
