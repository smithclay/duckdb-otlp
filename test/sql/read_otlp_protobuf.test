# name: test/sql/read_otlp_protobuf.test
# description: Test reading OTLP protobuf files
# group: [sql]

#
# Note: A benign protobuf UTF-8 validation warning may appear during test initialization.
# This is a false positive from protobuf's wire format validation and does not affect
# functionality. The warning states: "String field 'opentelemetry.proto.trace.v1.Span.name'
# contains invalid UTF-8 data" but the data is valid ASCII/UTF-8.

require otlp

#
# Traces Tests
#

# Test reading traces protobuf - verify schema and row count
query I
SELECT COUNT(*)
FROM read_otlp_traces('test/data/otlp_traces.pb');
----
1

# Test traces schema - verify key column types
query IIIII
SELECT
    typeof(timestamp) as ts_type,
    typeof(trace_id) as trace_id_type,
    typeof(span_name) as name_type,
    typeof(service_name) as service_type,
    typeof(duration) as duration_type
FROM read_otlp_traces('test/data/otlp_traces.pb')
LIMIT 1;
----
TIMESTAMP_MS	VARCHAR	VARCHAR	VARCHAR	BIGINT

# Test traces - verify timestamp is extracted from protobuf
query I
SELECT timestamp IS NOT NULL
FROM read_otlp_traces('test/data/otlp_traces.pb');
----
true

# Test traces - verify service name extraction
query I
SELECT service_name IN ('test-service', 'trace-service')
FROM read_otlp_traces('test/data/otlp_traces.pb');
----
true

# Test traces - verify trace_id and span_id are non-empty
query II
SELECT
    LENGTH(trace_id) > 0 as has_trace_id,
    LENGTH(span_id) > 0 as has_span_id
FROM read_otlp_traces('test/data/otlp_traces.pb');
----
true	true

#
# Logs Tests
#

# Test reading logs protobuf - verify row count
query I
SELECT COUNT(*)
FROM read_otlp_logs('test/data/otlp_logs.pb');
----
1

# Test logs schema - verify key column types
query IIII
SELECT
    typeof(timestamp) as ts_type,
    typeof(service_name) as service_type,
    typeof(severity_text) as severity_type,
    typeof(body) as body_type
FROM read_otlp_logs('test/data/otlp_logs.pb')
LIMIT 1;
----
TIMESTAMP_MS	VARCHAR	VARCHAR	VARCHAR

# Test logs - verify service name extraction
query I
SELECT service_name IN ('test-service', 'logs-service', 'log-service')
FROM read_otlp_logs('test/data/otlp_logs.pb');
----
true

# Test logs - verify body content is not empty
query I
SELECT LENGTH(body) > 0
FROM read_otlp_logs('test/data/otlp_logs.pb');
----
true
